{"version":3,"sources":["webpack:///webpack/bootstrap 608ad2667af0d9f27830","webpack:///./server/config/index.js","webpack:///external \"winston\"","webpack:///external \"express\"","webpack:///external \"express-session\"","webpack:///./server/db/index.js","webpack:///./server/db/models/index.js","webpack:///./server/server.js","webpack:///external \"http\"","webpack:///./server/app.js","webpack:///external \"path\"","webpack:///external \"cookie-parser\"","webpack:///external \"body-parser\"","webpack:///external \"express-flash\"","webpack:///external \"fs\"","webpack:///external \"method-override\"","webpack:///external \"compression\"","webpack:///external \"helmet\"","webpack:///external \"morgan\"","webpack:///external \"serialize-javascript\"","webpack:///./server/db/connect.js","webpack:///external \"sequelize\"","webpack:///./server/db/sequelize_config.json","webpack:///./server/db/models/shop.js","webpack:///./server/db/session.js","webpack:///external \"connect-redis\"","webpack:///./server/routes/shopify.js","webpack:///external \"lodash\"","webpack:///external \"crypto\"","webpack:///external \"shopify-token\"","webpack:///external \"shopify-api-node\"","webpack:///external \"dotenv\""],"names":["ENV","isProduction","isDebug","isClient","window","isTest","SCOPES","ACTIVATE_CHARGE_ROUTE","APP_NAME","APP_URL","APP_HOME_ROUTE","AUTH_CALLBACK_ROUTE","INSTALL_PAGE","UNINSTALL_ROUTE","sessionSecret","process","env","SESSION_SECRET","REDIS_URL","connect","Models","sequelize","session","config","db","dbUrl","use_env_variable","database","username","password","Shop","import","Object","keys","forEach","modelName","associate","port","PORT","set","server","createServer","listen","console","log","get","onError","error","syscall","bind","code","exit","onListening","addr","address","on","require","SHOPIFY_API_KEY","app","use","frameguard","action","domain","join","__dirname","rawBodySaver","req","res","buf","encoding","length","rawBody","toString","json","verify","urlencoded","extended","staticOptions","index","static","sessionConfig","resave","saveUninitialized","secret","proxy","name","cookie","httpOnly","secure","store","shopify","product","list","limit","then","status","products","next","shop","environment","SHOP_ORIGIN","readFile","err","content","replacement","result","replace","send","render","message","stack","authenticate","info","catch","DataTypes","define","type","STRING","unique","chargeId","BIGINT","classMethods","RedisStore","url","router","Router","SHOPIFY_API_SECRET","getShopifyToken","sharedSecret","redirectUri","scopes","apiKey","getAppsHome","getEmbeddedAppHome","query","body","redirect","shopifyToken","nonce","generateNonce","state","shopName","split","decodeURI","generateAuthUrl","undefined","getShopifyApi","shopUrl","token","accessToken","afterShopifyAuth","webhook","topic","format","create","createRecurringApplicationCharge","newCharge","price","return_url","test","trial_days","recurringApplicationCharge","charge","confirmation_url","hasActiveRecurringApplicationCharge","find","charges","verifyHmac","getAccessToken","findOrCreate","where","spread","isActive","verifyWebhookHMAC","hmac","headers","digest","createHmac","update","post","destroy","authMiddleware","charge_id","activate","order","orders","checkActiveRecurringApplicationCharge","checkForValidSession"],"mappings":"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","file":"server.dev.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"/assets/\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 6);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 608ad2667af0d9f27830","export const ENV = process.env.NODE_ENV || 'development';\nexport const isProduction = ENV === 'production';\nexport const isDebug = ENV === 'development';\nexport const isClient = typeof window !== 'undefined';\nexport const isTest = ENV === 'test';\n\nexport const SCOPES = 'read_orders,read_products';\nexport const ACTIVATE_CHARGE_ROUTE = '/activate_charge';\n\n/* export const APP_NAME = 'testapp999'; //Live */\nexport const APP_NAME = 'demotestapp999'; //Stagging\n\n/* export const APP_URL = 'https://artcontent.herokuapp.com';Live */\nexport const APP_URL = 'https://bcb26522.ngrok.io'; //Stagging\n\nexport const APP_HOME_ROUTE = '/home';\nexport const AUTH_CALLBACK_ROUTE = '/auth/callback';\nexport const INSTALL_PAGE = `https://apps.shopify.com/${APP_NAME}`;\nexport const UNINSTALL_ROUTE = '/uninstall';\n\nexport const sessionSecret =\n  process.env.SESSION_SECRET || 'Your Session Secret goes here';\n\nexport const REDIS_URL = process.env.REDIS_URL || 'redis://:@127.0.0.1:6379';\n\n\n\n// WEBPACK FOOTER //\n// ./server/config/index.js","module.exports = require(\"winston\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"winston\"\n// module id = 1\n// module chunks = 0","module.exports = require(\"express\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"express\"\n// module id = 2\n// module chunks = 0","module.exports = require(\"express-session\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"express-session\"\n// module id = 3\n// module chunks = 0","import connect from './connect';\nimport session from './session';\nimport { Models, sequelize } from './models';\n\nexport { connect, Models, sequelize, session };\n\n\n\n// WEBPACK FOOTER //\n// ./server/db/index.js","import Sequelize from 'sequelize';\n\nimport { ENV } from '../../config';\nimport sequelizeConfig from '../sequelize_config.json';\nimport shopModel from './shop';\n\nconst config = sequelizeConfig[ENV];\n\nconst db = {};\n\nconst dbUrl = process.env[config.use_env_variable];\n\nconst { database, username, password } = config;\n\nconst sequelize = dbUrl\n  ? new Sequelize(dbUrl)\n  : new Sequelize(database, username, password, config);\n\ndb.Shop = sequelize.import('Shop', shopModel);\n\nObject.keys(db).forEach((modelName) => {\n  if (db[modelName].associate) {\n    db[modelName].associate(db);\n  }\n});\n\nexport { db as Models, sequelize };\n\n\n\n// WEBPACK FOOTER //\n// ./server/db/models/index.js","import http from 'http';\nimport app from './app';\n\n/**\n * Get port from environment and store in Express.\n */\nconst port = process.env.PORT || '3001';\napp.set('port', port);\n\n/**\n * Create HTTP server.\n */\nconst server = http.createServer(app);\n\n/**\n * Listen on provided port, on all network interfaces.\n */\nserver.listen(port);\n\nconsole.log('--------------------------');\nconsole.log('===> ðŸ˜Š  Starting Server . . .');\nconsole.log(`===>  Environment: ${process.env.NODE_ENV}`);\nconsole.log(`===>  Listening on port: ${app.get('port')}`);\nconsole.log('--------------------------');\n\n/**\n * Event listener for HTTP server \"error\" event.\n */\nfunction onError(error) {\n  if (error.syscall !== 'listen') {\n    throw error;\n  }\n\n  const bind = typeof port === 'string' ? `Pipe ${port}` : `Port ${port}`;\n\n  // handle specific listen errors with friendly messages\n  switch (error.code) {\n    case 'EACCES':\n      console.error(`${bind} requires elevated privileges`);\n      process.exit(1);\n      break;\n    case 'EADDRINUSE':\n      console.error(`${bind} is already in use`);\n      process.exit(1);\n      break;\n    default:\n      throw error;\n  }\n}\n\n/**\n * Event listener for HTTP server \"listening\" event.\n */\n\nfunction onListening() {\n  const addr = server.address();\n  const bind = typeof addr === 'string' ? `pipe ${addr}` : `port ${addr.port}`;\n  console.log(`Listening on ${bind}`);\n}\n\nserver.on('error', onError);\nserver.on('listening', onListening);\n\n\n\n// WEBPACK FOOTER //\n// ./server/server.js","module.exports = require(\"http\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"http\"\n// module id = 7\n// module chunks = 0","import express from 'express';\nimport path from 'path';\n// import favicon from 'serve-favicon';\nimport cookieParser from 'cookie-parser';\nimport bodyParser from 'body-parser';\nimport flash from 'express-flash';\nimport fs from 'fs';\nimport methodOverride from 'method-override';\nimport gzip from 'compression';\nimport helmet from 'helmet';\nimport morgan from 'morgan';\nimport serialize from 'serialize-javascript';\nimport session from 'express-session';\nimport logger from 'winston';\n\nimport { APP_URL, ENV, isDebug, isProduction, sessionSecret } from './config';\n\nimport { connect, session as sessionStore } from './db';\n\nimport initShopify from './routes/shopify';\n\n// We configure dotenv as early as possible in the app\nrequire('dotenv').config();\n\n// Connect database\nconnect();\n\nconst { SHOPIFY_API_KEY } = process.env;\n\nconst app = express();\n\nif (ENV === 'production') {\n  app.use(gzip());\n  // Secure your Express apps by setting various HTTP headers. Documentation: https://github.com/helmetjs/helmet\n  app.use(\n    helmet({\n      frameguard: {\n        action: 'allow-from',\n        domain: 'https://myshopify.com'\n      }\n    })\n  );\n}\n\nconst env = {\n  SHOPIFY_API_KEY\n};\n\n// view engine setup\napp.set('views', path.join(__dirname, 'views'));\napp.set('view engine', 'pug');\n\n// app.use(favicon(path.join(__dirname, 'public', 'favicon.ico')));\napp.use(morgan(isDebug ? 'dev' : 'combined'));\n\nconst rawBodySaver = (req, res, buf, encoding) => {\n  if (buf && buf.length) {\n    req.rawBody = buf.toString(encoding || 'utf8');\n  }\n};\n\napp.use(bodyParser.json({ verify: rawBodySaver }));\napp.use(bodyParser.urlencoded({ extended: false }));\n\napp.use(methodOverride());\napp.use(cookieParser());\n\nconst staticOptions = isProduction && { index: '_' };\napp.use(\n  express.static(path.join(__dirname, '../react-ui/build'), staticOptions)\n);\n\nconst sessionConfig = {\n  resave: false,\n  saveUninitialized: false,\n  secret: sessionSecret,\n  proxy: true, // The \"X-Forwarded-Proto\" header will be used.\n  name: 'sessionId',\n  // Add HTTPOnly, Secure attributes on Session Cookie\n  // If secure is set, and you access your site over HTTP, the cookie will not be set\n  cookie: {\n    httpOnly: true,\n    secure: ENV === 'production'\n  },\n  store: sessionStore\n};\n\napp.use(session(sessionConfig));\napp.use(flash());\n\napp.use('/', initShopify());\n\napp.get('/api/products', (req, res) => {\n  const { shopify } = req;\n\n  shopify.product.list({ limit: 5 }).then(products => {\n    res.status(200).json(products);\n  });\n});\n\n\n/* app.get('/api/appcharges', function (req, res) {\n  var shopify = req.shopify;\n  console.log(dbcon);\n   const query = client.query('SELECT * FROM blogList'); \n  res.status(200).json(shopify);\n}); */\n\n\napp.get('*', (req, res, next) => {\n  const { shop } = req.session.shopify || {};\n\n  const environment = { ...env, SHOP_ORIGIN: shop };\n\n  fs.readFile(\n    path.join(__dirname, '../react-ui/build/index.html'),\n    'utf8',\n    (err, content) => {\n      if (err) {\n        return next(err);\n      }\n\n      // Inject environment variables (Shopify API key and shop) in client code,\n      // to be usd by the embedded app\n      const replacement = `window.env = ${serialize(environment)}`;\n      const result = content.replace('var __ENVIRONMENT__', replacement);\n      return res.send(result);\n    }\n  );\n});\n\n// eslint-disable-next-line no-unused-vars\napp.use((err, req, res, next) => {\n  logger.error(err);\n  const status = err.status || 500;\n\n  res.status(status);\n  res.render(`${status}`, {\n    message: err.message,\n    error: isDebug && err.stack,\n    APP_URL\n  });\n});\n\nexport default app;\n\n\n\n// WEBPACK FOOTER //\n// ./server/app.js","module.exports = require(\"path\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"path\"\n// module id = 9\n// module chunks = 0","module.exports = require(\"cookie-parser\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"cookie-parser\"\n// module id = 10\n// module chunks = 0","module.exports = require(\"body-parser\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"body-parser\"\n// module id = 11\n// module chunks = 0","module.exports = require(\"express-flash\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"express-flash\"\n// module id = 12\n// module chunks = 0","module.exports = require(\"fs\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"fs\"\n// module id = 13\n// module chunks = 0","module.exports = require(\"method-override\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"method-override\"\n// module id = 14\n// module chunks = 0","module.exports = require(\"compression\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"compression\"\n// module id = 15\n// module chunks = 0","module.exports = require(\"helmet\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"helmet\"\n// module id = 16\n// module chunks = 0","module.exports = require(\"morgan\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"morgan\"\n// module id = 17\n// module chunks = 0","module.exports = require(\"serialize-javascript\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"serialize-javascript\"\n// module id = 18\n// module chunks = 0","import logger from 'winston';\nimport { sequelize } from './models';\n\nexport default () => {\n  sequelize\n    .authenticate()\n    .then(() => {\n      logger.info('Connection has been established successfully.');\n    })\n    .catch((err) => {\n      logger.error('Unable to connect to the database:', err);\n    });\n};\n\n\n\n// WEBPACK FOOTER //\n// ./server/db/connect.js","module.exports = require(\"sequelize\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"sequelize\"\n// module id = 20\n// module chunks = 0","module.exports = {\"development\":{\"username\":\"postgres\",\"password\":\"TechAdmin\",\"database\":\"shopify-app-development\",\"host\":\"127.0.0.1\",\"dialect\":\"postgres\"},\"test\":{\"username\":\"postgres\",\"password\":\"TechAdmin\",\"database\":\"shopify-app-test\",\"host\":\"127.0.0.1\",\"dialect\":\"postgres\",\"logging\":false},\"production\":{\"use_env_variable\":\"DATABASE_URL\",\"username\":\"postgres\",\"password\":\"TechAdmin\",\"database\":\"shopify-app-production\",\"host\":\"127.0.0.1\",\"dialect\":\"postgres\"}}\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./server/db/sequelize_config.json\n// module id = 21\n// module chunks = 0","export default (sequelize, DataTypes) => {\n  const Shop = sequelize.define(\n    'Shop',\n    {\n      domain: {\n        type: DataTypes.STRING,\n        unique: true\n      },\n      chargeId: {\n        type: DataTypes.BIGINT,\n        unique: true\n      }\n    },\n    {\n      classMethods: {\n        associate() {\n          // associations can be defined here\n        }\n      }\n    }\n  );\n  return Shop;\n};\n\n\n\n// WEBPACK FOOTER //\n// ./server/db/models/shop.js","import session from 'express-session';\nimport connectRedis from 'connect-redis';\n\nimport { isTest, REDIS_URL } from '../config';\n\nconst RedisStore = connectRedis(session);\n\nconst store = new RedisStore({\n  url: REDIS_URL,\n  // We use the 2nd database in Redis (1) in test to be able to clean it.\n  db: isTest ? 1 : 0,\n});\n\nstore.on('connect', () => {\n  console.log(`===> ðŸ˜Š  Connected to Redis Server on ${REDIS_URL}. . .`);\n});\n\nexport default store;\n\n\n\n// WEBPACK FOOTER //\n// ./server/db/session.js","module.exports = require(\"connect-redis\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"connect-redis\"\n// module id = 24\n// module chunks = 0","/**\n * Routes for express app\n */\nimport _ from 'lodash';\nimport crypto from 'crypto';\nimport express from 'express';\nimport ShopifyToken from 'shopify-token';\nimport ShopifyApi from 'shopify-api-node';\nimport logger from 'winston';\n\nimport {\n  ACTIVATE_CHARGE_ROUTE,\n  APP_HOME_ROUTE,\n  APP_NAME,\n  APP_URL,\n  AUTH_CALLBACK_ROUTE,\n  INSTALL_PAGE,\n  SCOPES,\n  UNINSTALL_ROUTE\n} from '../config';\n\nimport { Models } from '../db';\n\nconst { Shop } = Models;\n\nconst router = express.Router();\n\nexport default () => {\n  const { SHOPIFY_API_KEY, SHOPIFY_API_SECRET } = process.env;\n\n  const getShopifyToken = () =>\n    new ShopifyToken({\n      sharedSecret: SHOPIFY_API_SECRET,\n      redirectUri: `${APP_URL}${AUTH_CALLBACK_ROUTE}`,\n      scopes: SCOPES,\n      apiKey: SHOPIFY_API_KEY\n    });\n\n  const getAppsHome = shop => `https://${shop}/admin/apps/`;\n\n  // The home page of the app in Shopify Admin\n  const getEmbeddedAppHome = shop => `${getAppsHome(shop)}${APP_NAME}`;\n\n  /**\n   * Authenticates the shop with Shopify when accessing protected routes.\n   * Returns a template file that redirects to the Shopify authorization page.\n   * This mechanism is used to authorize an embedded app.\n   * We need custom Javascript to escape the iframe as described in the docs.\n   * See the \"shopify_redirect\" template for details.\n   */\n  const authenticate = (req, res) => {\n    const { query, session } = req;\n\n    const shop = query.shop || req.body.shop;\n\n    logger.info('Authenticating shop %s', shop);\n\n    if (!shop) {\n      res.redirect(INSTALL_PAGE);\n      return;\n    }\n\n    const shopifyToken = getShopifyToken();\n    const nonce = shopifyToken.generateNonce();\n\n    // Save the nonce to state to verify it in the callback route later on\n    session.state = nonce;\n\n    const shopName = shop.split('.')[0];\n\n    const url = decodeURI(\n      shopifyToken.generateAuthUrl(shopName, undefined, nonce)\n    );\n\n    res.render('shopify_redirect', { url, shop });\n  };\n\n  /**\n   * Creates an interface for accessing the Shopify API.\n   * @param session A Shopify session with shop domain and access token\n   */\n  const getShopifyApi = session => {\n    const { shopify: { shop: shopUrl, token } } = session;\n\n    return new ShopifyApi({\n      shopName: shopUrl.split('.')[0],\n      accessToken: token\n    });\n  };\n\n  /**\n   * This method gets called when the app is installed.\n   * Setup any webhooks or services you need on Shopify inside here.\n   *\n   * @param session New session\n   */\n  const afterShopifyAuth = session => {\n    const shopify = getShopifyApi(session);\n\n    const webhook = {\n      topic: 'app/uninstalled',\n      address: `${APP_URL}${UNINSTALL_ROUTE}`,\n      format: 'json'\n    };\n\n    shopify.webhook.create(webhook);\n  };\n\n  /**\n   * Creates a new recurring application charge and redirects the mercant to\n   * the confirmation screen.\n   */\n  const createRecurringApplicationCharge = (req, res, next) => {\n    const { shopify, session: { shopify: { shop } } } = req;\n\n    const newCharge = {\n      name: APP_NAME,\n      price: 9.99,\n      return_url: `${APP_URL}${ACTIVATE_CHARGE_ROUTE}`,\n      test: true,\n      trial_days: 7\n    };\n\n    shopify.recurringApplicationCharge\n      .create(newCharge)\n      .then(charge => {\n        res.render('shopify_redirect', {\n          url: charge.confirmation_url,\n          shop\n        });\n      })\n      .catch(next);\n  };\n\n  const hasActiveRecurringApplicationCharge = shopify =>\n    shopify.recurringApplicationCharge\n      .list()\n      .then(charges => _.find(charges, { status: 'active' }));\n\n  /**\n   * Shopify calls this route after the merchant authorizes the app.\n   * It needs to match the callback route that you set in app settings.\n   */\n  router.get(AUTH_CALLBACK_ROUTE, (req, res, next) => {\n    const { query, session } = req;\n\n    const { code, shop, state } = query;\n\n    const shopifyToken = getShopifyToken();\n\n    if (\n      typeof state !== 'string' ||\n      state !== session.state || // Validate the state.\n      !shopifyToken.verifyHmac(query) // Validate the hmac.\n    ) {\n      return res.status(400).send('Security checks failed');\n    }\n\n    // Exchange the authorization code for a permanent access token.\n    return shopifyToken\n      .getAccessToken(shop, code)\n      .then(token => {\n        session.shopify = { shop, token };\n\n        return Shop.findOrCreate({\n          where: {\n            domain: shop\n          }\n        }).spread(() => {\n          afterShopifyAuth(session);\n\n          req.shopify = getShopifyApi(session);\n\n          hasActiveRecurringApplicationCharge(req.shopify).then(isActive => {\n            if (isActive) {\n              return res.redirect(getEmbeddedAppHome(shop));\n            }\n            return createRecurringApplicationCharge(req, res, next);\n          });\n        });\n      })\n      .catch(next);\n  });\n\n  const verifyWebhookHMAC = req => {\n    const hmac = req.headers['x-shopify-hmac-sha256'];\n\n    const digest = crypto\n      .createHmac('SHA256', SHOPIFY_API_SECRET)\n      .update(req.rawBody)\n      .digest('base64');\n\n    return digest === hmac;\n  };\n\n  /**\n   * This endpoint recieves the uninstall webhook and cleans up data.\n   * Add to this endpoint as your app stores more data. If you need to do a lot of work, return 200\n   * right away and queue it as a worker job.\n   */\n  router.post(UNINSTALL_ROUTE, (req, res) => {\n    if (!verifyWebhookHMAC(req)) {\n      res.status(401).send('Webhook HMAC Failed');\n      return;\n    }\n\n    Shop.destroy({\n      where: {\n        domain: req.headers['x-shopify-shop-domain']\n      }\n    }).then(() => {\n      res.status(200).send('Uninstalled');\n    });\n  });\n\n  /**\n   * This middleware checks if we have a session.\n   * If so, it attaches the Shopify API to the request object.\n   * If there is no session or we have a different shop,\n   * we start the authentication process.\n   */\n  const authMiddleware = (req, res, next) => {\n    logger.info(`Checking for valid session: ${req.query.shop}`);\n    const { session, query: { shop } } = req;\n\n    if (!session.shopify || (shop && session.shopify.shop !== shop)) {\n      delete session.shopify;\n      authenticate(req, res);\n      return;\n    }\n\n    req.shopify = getShopifyApi(session);\n    next();\n  };\n\n  router.use(authMiddleware);\n\n  /*\n   * Shopify calls this route when the merchant accepts or declines the charge.\n   */\n  router.get('/activate_charge', (req, res, next) => {\n    const {\n      shopify: { recurringApplicationCharge },\n      query: { charge_id: chargeId },\n      session: { shopify: { shop } }\n    } = req;\n\n    recurringApplicationCharge\n      .get(chargeId)\n      .then(charge => {\n        if (charge.status === 'accepted') {\n          return recurringApplicationCharge.activate(chargeId).then(() =>\n            // We redirect to the home page of the app in Shopify admin\n            res.redirect(getEmbeddedAppHome(shop))\n          );\n        }\n        res.status(401);\n        return res.render('charge_declined', { APP_URL });\n      })\n      .catch(next);\n  });\n\n  router.get('/logout', (req, res) => {\n    const { shop } = req.session.shopify;\n\n    delete req.session.shopify;\n\n    res.redirect(getAppsHome(shop));\n  });\n\n  router.get('/api/orders', (req, res) => {\n    const { shopify } = req;\n\n    shopify.order.list({ limit: 5 }).then(orders => {\n      res.status(200).json(orders);\n    });\n  });\n\n  /**\n   * Checks if we have an active application charge.\n   * This middleware is active when the app is initially loaded.\n   */\n  const checkActiveRecurringApplicationCharge = (req, res, next) => {\n    logger.info(`Checking for active application charge: ${req.query.shop}`);\n    const { shopify } = req;\n\n    hasActiveRecurringApplicationCharge(shopify).then(isActive => {\n      if (!isActive) {\n        logger.info(`No active charge found: ${req.query.shop}`);\n        createRecurringApplicationCharge(req, res);\n        return;\n      }\n      next();\n    });\n  };\n\n  /*\n   * Checks if the session is still valid by making a basic API call, as described in:\n   * https://stackoverflow.com/questions/14418415/shopify-how-can-i-handle-an-uninstall-followed-by-an-instant-re-install\n   */\n  const checkForValidSession = (req, res, next) => {\n    logger.info(`Checking if the session is still valid: ${req.query.shop}`);\n    const { session, shopify } = req;\n\n    return shopify.shop\n      .get()\n      .then(() => next())\n      .catch(() => {\n        // Destroy the Shopify reference\n        delete session.shopify;\n        authenticate(req, res);\n      });\n  };\n\n  router.get(\n    APP_HOME_ROUTE,\n    checkForValidSession,\n    checkActiveRecurringApplicationCharge,\n    (req, res) => {\n      res.redirect('/');\n    }\n  );\n\n  return router;\n};\n\n\n\n// WEBPACK FOOTER //\n// ./server/routes/shopify.js","module.exports = require(\"lodash\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"lodash\"\n// module id = 26\n// module chunks = 0","module.exports = require(\"crypto\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"crypto\"\n// module id = 27\n// module chunks = 0","module.exports = require(\"shopify-token\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"shopify-token\"\n// module id = 28\n// module chunks = 0","module.exports = require(\"shopify-api-node\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"shopify-api-node\"\n// module id = 29\n// module chunks = 0","module.exports = require(\"dotenv\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"dotenv\"\n// module id = 30\n// module chunks = 0"],"sourceRoot":""}